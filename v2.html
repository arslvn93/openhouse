<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maison | The Open House</title>

    <!-- FONTS: Editorial & Elegant -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Italiana&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Montserrat:wght@200;300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- ANIMATION ENGINE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="config.js"></script>

    <style>
        /* 
         * ----------------------------------------------------------
         * 1. THE PALETTE (Rose Gold & Alabaster)
         * ----------------------------------------------------------
         */
        :root {
            --bg-base: #fdfcfb; /* Soft Cream */
            --bg-gradient: radial-gradient(circle at top right, #fdfbf7, #f5f0ed);
            
            --accent-rose: #d4af9b; /* Muted Rose */
            --accent-gold: #c5a059; /* Champagne Gold */
            --accent-blush: #eaddcf;
            
            --text-dark: #2a2a2a; /* Charcoal, not black */
            --text-light: #666666;
            
            --glass-surface: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-shadow: 0 20px 60px rgba(212, 175, 155, 0.15);
            
            --font-display: 'Italiana', serif;
            --font-body: 'Cormorant Garamond', serif;
            --font-ui: 'Montserrat', sans-serif;
            
            --ease-silk: cubic-bezier(0.33, 1, 0.68, 1);
        }

        /* Base Reset */
        *, *::before, *::after { box-sizing: border-box; cursor: none; } /* Custom cursor enabled */
        
        body {
            margin: 0;
            padding: 0;
            background: var(--bg-base);
            color: var(--text-dark);
            font-family: var(--font-body);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* 
         * ----------------------------------------------------------
         * 2. ATMOSPHERE & CURSOR
         * ----------------------------------------------------------
         */
        
        /* Soft Halo Cursor */
        #cursor {
            position: fixed;
            top: 0; left: 0;
            width: 30px; height: 30px;
            background: rgba(212, 175, 155, 0.3);
            border: 1px solid rgba(212, 175, 155, 0.5);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s, background 0.4s;
            backdrop-filter: blur(2px);
        }
        #cursor.hovered {
            width: 60px; height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-gold);
        }
        
        /* Film Grain Texture (Subtle) */
        .texture-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://grainy-gradients.vercel.app/noise.svg');
            opacity: 0.03;
            pointer-events: none;
            z-index: 5;
            mix-blend-mode: multiply;
        }

        /* Canvas Background */
        #silk-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            opacity: 0.6;
        }

        /* 
         * ----------------------------------------------------------
         * 3. TYPOGRAPHY & UTILITIES
         * ----------------------------------------------------------
         */
        .container { max-width: 1100px; margin: 0 auto; padding: 0 6%; position: relative; z-index: 10; }
        
        h1, h2, h3 { font-family: var(--font-display); font-weight: 400; margin: 0; line-height: 1; color: var(--text-dark); }
        
        .text-gold { color: var(--accent-gold); }
        
        .eyebrow {
            font-family: var(--font-ui);
            font-size: 0.65rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--accent-rose);
            display: block;
            margin-bottom: 1.5rem;
        }

        /* The "Pearl" Button */
        .btn-pearl {
            background: rgba(255,255,255,0.8);
            border: 1px solid var(--accent-blush);
            color: var(--text-dark);
            padding: 1.2rem 3.5rem;
            font-family: var(--font-ui);
            font-size: 0.75rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            border-radius: 50px; /* Rounded pill shape */
            position: relative;
            overflow: hidden;
            transition: all 0.6s var(--ease-silk);
            box-shadow: 0 10px 30px rgba(212, 175, 155, 0.2);
            display: inline-block;
            text-decoration: none;
        }
        .btn-pearl::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255,255,255,0.8), transparent);
            transform: translateX(-100%);
            transition: 0.6s;
        }
        .btn-pearl:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(212, 175, 155, 0.4);
            border-color: var(--accent-gold);
        }
        .btn-pearl:hover::after { transform: translateX(100%); }

        /* 
         * ----------------------------------------------------------
         * 4. LAYOUT SECTIONS
         * ----------------------------------------------------------
         */
        
        /* Nav */
        nav {
            position: fixed;
            top: 0; left: 0; width: 100%;
            padding: 2.5rem 0;
            z-index: 100;
            transition: 0.6s var(--ease-silk);
        }
        nav.scrolled {
            padding: 1rem 0;
            background: rgba(253, 252, 251, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .nav-inner { display: flex; justify-content: space-between; align-items: center; }
        .brand { 
            font-family: var(--font-display); 
            font-size: 2rem; 
            color: var(--text-dark); 
            text-decoration: none;
            letter-spacing: -0.02em; 
        }

        /* Hero */
        #hero {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .hero-image-frame {
            position: absolute;
            top: 15%; left: 15%; right: 15%; bottom: 15%;
            overflow: hidden;
            z-index: 1;
            border-radius: 300px 300px 0 0; /* Arch Shape */
            opacity: 0; /* JS Fade In */
            transform: scale(0.9);
        }
        .hero-bg-img {
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scale(1.2); /* For Parallax */
        }
        .hero-content {
            position: relative;
            z-index: 2;
            mix-blend-mode: normal;
        }
        .hero-title {
            font-size: clamp(3.5rem, 9vw, 9rem);
            color: #fff;
            text-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin-bottom: 1rem;
        }
        
        /* Amenities (The "Details") */
        section { padding: 140px 0; position: relative; }
        
        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 4rem;
            box-shadow: var(--glass-shadow);
        }

        .amenities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 3rem;
            margin-top: 3rem;
        }
        .amenity-card {
            text-align: center;
            padding: 2rem;
            transition: 0.4s;
            border-radius: 16px;
            background: rgba(255,255,255,0.4);
        }
        .amenity-card:hover { background: #fff; transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .amenity-icon { font-size: 2rem; color: var(--accent-rose); margin-bottom: 1rem; }
        
        /* Host Section */
        .host-layout { display: flex; align-items: center; gap: 5rem; flex-wrap: wrap-reverse; }
        .host-img-wrapper {
            flex: 1; min-width: 300px;
            position: relative;
            border-radius: 200px 200px 0 0; /* Arch */
            overflow: hidden;
        }
        .host-img { width: 100%; display: block; aspect-ratio: 3/4; object-fit: cover; transition: 0.5s; }
        .host-img:hover { transform: scale(1.05); }

        /* Form Styling (Editorial Lines) */
        .form-line {
            position: relative;
            margin-bottom: 3rem;
        }
        .input-editorial {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding: 1rem 0;
            font-family: var(--font-display);
            font-size: 1.8rem;
            color: var(--text-dark);
            transition: 0.4s;
            border-radius: 0;
        }
        .input-editorial:focus {
            outline: none;
            border-bottom-color: var(--accent-rose);
        }
        .label-editorial {
            position: absolute;
            top: 0; left: 0;
            font-family: var(--font-ui);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-light);
            transform: translateY(1.5rem);
            transition: 0.4s;
            pointer-events: none;
        }
        .input-editorial:focus ~ .label-editorial,
        .input-editorial:not(:placeholder-shown) ~ .label-editorial {
            transform: translateY(-1rem);
            color: var(--accent-rose);
            font-size: 0.65rem;
        }

        /* Checkbox */
        .consent-wrapper {
            display: flex; gap: 15px; align-items: flex-start;
            font-size: 0.85rem; color: var(--text-light);
            margin-bottom: 3rem;
            padding: 1.5rem;
            background: rgba(255,255,255,0.5);
            border-radius: 12px;
        }
        .consent-wrapper input { accent-color: var(--accent-rose); margin-top: 3px; }

        /* Footer */
        footer {
            background: #f5f0ed;
            padding: 5rem 0;
            text-align: center;
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        .social-list a { color: var(--text-dark); margin: 0 15px; font-size: 1.2rem; transition: 0.3s; }
        .social-list a:hover { color: var(--accent-rose); }

        /* 
         * ----------------------------------------------------------
         * 5. MODAL (Concierge Style)
         * ----------------------------------------------------------
         */
        .modal-curtain {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(253, 252, 251, 0.95);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.6s var(--ease-silk);
        }
        .modal-curtain.active { opacity: 1; pointer-events: all; }
        .modal-inner { max-width: 600px; text-align: center; transform: translateY(30px); transition: 0.6s; }
        .modal-curtain.active .modal-inner { transform: translateY(0); }
        
        .option-pill {
            display: block; width: 100%;
            background: #fff;
            border: 1px solid rgba(0,0,0,0.08);
            padding: 1.2rem;
            margin-bottom: 1rem;
            border-radius: 50px;
            font-family: var(--font-ui);
            color: var(--text-dark);
            transition: 0.3s;
            font-size: 0.9rem;
        }
        .option-pill:hover {
            background: var(--accent-blush);
            border-color: var(--accent-rose);
            transform: scale(1.02);
        }

        /* Curtain Loader */
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fdfcfb; z-index: 99999;
            display: flex; align-items: center; justify-content: center;
            transition: transform 1s cubic-bezier(0.7, 0, 0.3, 1);
        }
        
        /* Responsive */
        @media(max-width: 768px) {
            .hero-image-frame { top: 0; left: 0; right: 0; bottom: 0; border-radius: 0; opacity: 1; }
            .hero-title { font-size: 4rem; }
            .host-layout { gap: 2rem; }
            .glass-panel { padding: 2rem; }
        }

    </style>
</head>
<body>

    <!-- PRELOADER -->
    <div id="preloader">
        <h1 style="font-size: 2rem; letter-spacing: 0.3em;">MAISON</h1>
    </div>

    <!-- FX LAYERS -->
    <div id="cursor"></div>
    <div class="texture-overlay"></div>
    <canvas id="silk-canvas"></canvas>
    <canvas id="confetti-canvas" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:3000;"></canvas>

    <!-- NAV -->
    <nav id="mainNav">
        <div class="container nav-inner">
            <a href="#" class="brand hover-target" id="navBrand">MAISON</a>
            <span class="eyebrow" id="navAddress" style="margin:0; color: var(--text-light);">123 Avenue Montaigne</span>
        </div>
    </nav>

    <!-- HERO -->
    <section id="hero">
        <div class="hero-image-frame" id="heroFrame">
            <img src="" alt="Interior" class="hero-bg-img" id="heroImg">
        </div>
        <div class="container hero-content">
            <span class="eyebrow" style="color: #fff; letter-spacing: 0.5em;">WELCOME TO</span>
            <h1 class="hero-title" id="heroTitle">THE<br>RESIDENCE</h1>
            <p style="color: #eee; font-size: 1.2rem; margin-bottom: 3rem; font-style: italic;" id="heroSubtitle">An invitation to timeless elegance.</p>
            <a href="#register" class="btn-pearl hover-target">Request Entry</a>
        </div>
    </section>

    <!-- AMENITIES -->
    <section id="details">
        <div class="container">
            <div class="glass-panel" id="detailsPanel">
                <div style="text-align: center; margin-bottom: 4rem;">
                    <span class="eyebrow">Curated Details</span>
                    <h2 style="font-size: 3.5rem;">Life, Elevated</h2>
                </div>
                <div class="amenities-grid" id="amenitiesGrid">
                    <!-- JS Injected -->
                </div>
            </div>
        </div>
    </section>

    <!-- HOST -->
    <section id="host">
        <div class="container">
            <div class="host-layout">
                <div class="host-info" style="flex: 1.5;">
                    <span class="eyebrow">Your Concierge</span>
                    <h2 style="font-size: 4rem; margin-bottom: 1.5rem;" id="realtorName">Victoria Saint</h2>
                    <div style="width: 40px; height: 1px; background: var(--accent-rose); margin-bottom: 2rem;"></div>
                    <p style="font-size: 1.2rem; line-height: 1.8; color: var(--text-light); margin-bottom: 3rem;" id="realtorBio">
                        Curating homes for the discerning few. I am dedicated to ensuring your experience at The Residence is as seamless as it is inspiring.
                    </p>
                    <div id="realtorContactInfo" style="margin-bottom: 2rem; color: var(--text-light); font-family: var(--font-ui); font-size: 0.9rem;"></div>
                    <div class="social-list" id="socialLinks"></div>
                </div>
                <div class="host-img-wrapper">
                    <img src="" alt="Host" class="host-img" id="realtorPhoto">
                </div>
            </div>
        </div>
    </section>

    <!-- REGISTER -->
    <section id="register" style="padding-bottom: 10rem;">
        <div class="container">
            <div style="max-width: 700px; margin: 0 auto;">
                <div style="text-align: center; margin-bottom: 5rem;">
                    <span class="eyebrow">Guest Registry</span>
                    <h2 style="font-size: 3.5rem;">Unlock The Portfolio</h2>
                    <p style="color: var(--text-light); margin-top: 1rem;">Register to receive the floor plans and brochure.</p>
                </div>

                <form id="signInForm">
                    <div class="form-line">
                        <input type="text" id="fullName" class="input-editorial hover-target" placeholder=" " required>
                        <label class="label-editorial">Full Name</label>
                    </div>
                    
                    <div class="form-line">
                        <input type="email" id="email" class="input-editorial hover-target" placeholder=" " required>
                        <label class="label-editorial">Email Address</label>
                    </div>

                    <div class="form-line">
                        <input type="tel" id="phone" class="input-editorial hover-target" placeholder=" " required inputmode="numeric">
                        <label class="label-editorial">Phone Number</label>
                    </div>

                    <div class="consent-wrapper hover-target">
                        <input type="checkbox" id="consent" required>
                        <label for="consent">
                            By checking this, I agree to allow <span id="consentBrokerage" style="color:var(--text-dark); font-weight:600;">[Brokerage]</span> to contact me regarding this property via email or phone. <a href="#" style="color:var(--accent-rose);">Privacy Policy</a>.
                        </label>
                    </div>

                    <div style="text-align: center;">
                        <button type="submit" class="btn-pearl hover-target" id="submitBtn">
                            <span id="btnText">Access Portfolio</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <img id="footerLogo" src="" alt="Brokerage Logo" style="max-height: 60px; margin-bottom: 1.5rem; display: none;">
            <h2 style="font-size: 2rem; margin-bottom: 1rem;" id="footerBrand">MAISON</h2>
            <p style="color: var(--text-light); margin-bottom: 2rem;" id="footerAddress"></p>
            <div style="font-size: 0.85rem; opacity: 0.6;">
                &copy; <span id="year"></span> All Rights Reserved.
            </div>
        </div>
    </footer>

    <!-- MODAL -->
    <div class="modal-curtain" id="modalOverlay">
        <div class="modal-inner" id="modalContent">
            <!-- Dynamic JS -->
        </div>
    </div>

    <!-- LIBS -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        /**
         * ==================================================================
         * STATE & CONFIG
         * ==================================================================
         */
        let storedInitialPayload = null;
        let collectedAnswers = {};

        /**
         * ==================================================================
         * INITIALIZATION
         * ==================================================================
         */
        document.addEventListener("DOMContentLoaded", () => {
            
            // 1. Check Config
            if (typeof config === 'undefined') {
                console.error("Config not loaded");
                return;
            }

            // 2. Populate Content (Data Mapping)
            populateV2Data();

            // 3. Remove Preloader
            setTimeout(() => {
                document.getElementById('preloader').style.transform = "translateY(-100%)";
                
                // Trigger Hero Animations after loader
                gsap.to("#heroFrame", { opacity: 1, borderRadius: "300px 300px 0 0", transform: "scale(1)", duration: 1.5, ease: "power2.out", delay: 0.5 });
            }, 1000);

            // 4. Animations (GSAP)
            gsap.registerPlugin(ScrollTrigger);

            // Parallax Hero
            gsap.to(".hero-bg-img", {
                yPercent: 20,
                ease: "none",
                scrollTrigger: { trigger: "#hero", start: "top top", end: "bottom top", scrub: true }
            });

            // Reveal Sections
            gsap.utils.toArray("#detailsPanel, .host-layout").forEach(el => {
                gsap.from(el, {
                    opacity: 0, y: 50, duration: 1.2, ease: "power3.out",
                    scrollTrigger: { trigger: el, start: "top 80%" }
                });
            });

            // 5. Init Effects
            initCursor();
            initSilkCanvas();
        });

        function populateV2Data() {
            // Meta
            document.title = `${config.meta.pageTitlePrefix} | Maison`;
            
            // Nav
            setText('navBrand', config.brokerage.name || config.meta.navBrandLogoText || 'MAISON');
            setText('navAddress', config.property.streetAddress);

            // Hero
            const heroImg = document.getElementById('heroImg');
            if (heroImg && config.property.backgroundImageUrl) heroImg.src = config.property.backgroundImageUrl;
            
            // Use street address as title if available, allowing breaks
            const titleHTML = config.property.streetAddress ? config.property.streetAddress.toUpperCase().replace(/^(.*?)\s+(.*)$/, '$1<br>$2') : "THE<br>RESIDENCE";
            setHTML('heroTitle', titleHTML);
            setText('heroSubtitle', config.property.heroSubtitle);

            // Amenities
            const grid = document.getElementById('amenitiesGrid');
            if (grid && config.openHouse.bundleItems) {
                grid.innerHTML = '';
                config.openHouse.bundleItems.forEach(item => {
                    // Ensure icon has 'fa-' prefix if missing or just use as is if it has classes
                    // Config usually has full class string "fas fa-spa"
                    grid.innerHTML += `
                        <div class="amenity-card hover-target">
                            <i class="${item.icon} amenity-icon"></i>
                            <h3 style="font-size:1.2rem; font-family:var(--font-ui); letter-spacing:0.1em;">${item.text}</h3>
                        </div>`;
                });
            }

            // Host
            setText('realtorName', config.realtor.fullName);
            setText('realtorBio', config.realtor.bio);
            const realtorPhoto = document.getElementById('realtorPhoto');
            if (realtorPhoto) realtorPhoto.src = config.realtor.photoUrl;

            // Host Contact Info (New)
            const contactInfo = document.getElementById('realtorContactInfo');
            if (contactInfo) {
                contactInfo.innerHTML = `
                    <span style="display:block; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:0.1em;">${config.realtor.title}</span>
                    <a href="tel:${config.realtor.phone.replace(/\D/g,'')}" class="hover-target" style="color:inherit; text-decoration:none; margin-right:15px;">${config.realtor.phone}</a>
                    <a href="mailto:${config.realtor.email}" class="hover-target" style="color:inherit; text-decoration:none;">${config.realtor.email}</a>
                `;
            }

            // Socials
            const socialContainer = document.getElementById('socialLinks');
            if (socialContainer && config.realtor.social) {
                socialContainer.innerHTML = '';
                const platformIcons = { linkedin: 'fab fa-linkedin-in', instagram: 'fab fa-instagram', website: 'fas fa-globe', facebook: 'fab fa-facebook-f', twitter: 'fab fa-twitter'};
                for (const [platform, url] of Object.entries(config.realtor.social)) {
                    if (url) {
                        const iconClass = platformIcons[platform] || 'fas fa-link';
                        socialContainer.innerHTML += `<a href="${url}" class="hover-target" target="_blank"><i class="${iconClass}"></i></a>`;
                    }
                }
            }

            // Footer / Consent
            setText('consentBrokerage', config.brokerage.name);
            setText('footerBrand', config.brokerage.name);
            setText('footerAddress', config.brokerage.address);
            setText('year', new Date().getFullYear());
            
            const footerLogo = document.getElementById('footerLogo');
            if (footerLogo && config.brokerage.logoUrl) {
                footerLogo.src = config.brokerage.logoUrl;
                footerLogo.style.display = 'inline-block';
            }
            
            // Update Privacy Policy Link in form
            const privacyLink = document.querySelector('.consent-wrapper a');
            if (privacyLink && config.meta.privacyPolicyLink) {
                privacyLink.href = config.meta.privacyPolicyLink;
                privacyLink.target = "_blank";
            }
        }

        // Helpers
        function setText(id, txt) { const el = document.getElementById(id); if (el) el.textContent = txt; }
        function setHTML(id, html) { const el = document.getElementById(id); if (el) el.innerHTML = html; }


        /**
         * ==================================================================
         * FORM & LOGIC
         * ==================================================================
         */
        const form = document.getElementById('signInForm');

        // Phone Mask
        document.getElementById('phone')?.addEventListener('input', function (e) {
            var x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });

        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Button Loading State
                const btn = document.getElementById('submitBtn');
                const btnText = document.getElementById('btnText');
                if (btnText) btnText.textContent = "Verifying...";
                
                // 1. Build Initial Payload
                const fullName = document.getElementById('fullName').value;
                const email = document.getElementById('email').value;
                const phone = document.getElementById('phone').value;
                const submittedAt = new Date().toISOString();

                const initialPayload = {
                    formType: "initial_contact",
                    email: email,
                    fullName: fullName,
                    phone: phone,
                    propertyAddress: config.property.streetAddress, // simplified for v2
                    submittedAt: submittedAt,
                    questions: [],
                    agentEmail: config.realtor.email,
                    ...(config.deploymentInfo || {})
                };

                storedInitialPayload = initialPayload; // Store for step 2

                // 2. Send to Webhook
                const visitorUrl = config.settings.visitorWebhookUrl;
                if (visitorUrl) {
                    try {
                        fetch(visitorUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(initialPayload)
                        }); // Fire and forget for speed
                    } catch (err) {
                        console.error(err);
                    }
                }

                // 3. Open Modal (Delay for effect)
                setTimeout(() => {
                    openModal(0);
                }, 800);
            });
        }

        function openModal(index) {
            const modal = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            modal.classList.add('active');
            content.innerHTML = '';

            // Guard against no questions
            const questions = config.modalQuestions || [];

            if(index < questions.length) {
                const q = questions[index];
                // Handle options which are objects {value, text}
                const optionsHTML = q.options.map(opt => {
                    const val = opt.value || opt; // fallback if string
                    const txt = opt.text || opt;
                    return `<button class="option-pill hover-target" onclick="handleAnswer('${q.id}', '${val}', ${index})">${txt}</button>`;
                }).join('');

                content.innerHTML = `
                    <span class="eyebrow">Question ${index+1} of ${questions.length}</span>
                    <h3 style="font-size: 2.5rem; margin-bottom: 2rem;">${q.questionText}</h3>
                    <div>${optionsHTML}</div>
                `;
            } else {
                submitFinalAnswers();
            }
        }

        window.handleAnswer = (id, val, idx) => {
            collectedAnswers[id] = val;
            openModal(idx + 1);
        };

        async function submitFinalAnswers() {
            // 1. Process Answers into Array
            const questions = config.modalQuestions || [];
            const modalQuestionResponses = [];
            
            for (const [qId, answerVal] of Object.entries(collectedAnswers)) {
                const qObj = questions.find(q => q.id === qId);
                if (qObj) {
                    const optObj = qObj.options.find(o => o.value === answerVal);
                    modalQuestionResponses.push({
                        question: qObj.questionText,
                        answer: optObj ? optObj.text : answerVal
                    });
                }
            }

            // 2. Build Final Payload
            const finalPayload = {
                ...(storedInitialPayload || {}),
                formType: "modal_answers",
                submittedAt: new Date().toISOString(),
                questions: modalQuestionResponses
            };

            // 3. Send to Webhook
            const visitorUrl = config.settings.visitorWebhookUrl;
            if (visitorUrl) {
                try {
                    await fetch(visitorUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(finalPayload)
                    });
                } catch (err) {
                    console.error("Final submit error", err);
                }
            }

            // 4. Show Success UI
            showSuccess();
        }

        function showSuccess() {
            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <h3 style="font-size: 3rem; margin-bottom: 1rem; color: var(--accent-rose);">Merci.</h3>
                <p style="font-size: 1.2rem; color: var(--text-light);">The portfolio has been sent to your device.</p>
                <button onclick="location.reload()" class="btn-pearl hover-target" style="margin-top:2rem;">Close</button>
            `;
            fireSparkles();
        }

        function fireSparkles() {
            const end = Date.now() + 3000;
            // Use config colors or fallback
            const colors = config.settings.confettiColors || ['#d4af9b', '#ffffff', '#fdfcfb']; 
            
            (function frame() {
                confetti({
                    particleCount: 4,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: colors,
                    shapes: ['circle', 'square'],
                    scalar: 0.8
                });
                confetti({
                    particleCount: 4,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: colors,
                    shapes: ['circle', 'square'],
                    scalar: 0.8
                });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        /**
         * ==================================================================
         * CANVAS: SILK WAVE EFFECT
         * ==================================================================
         */
        function initSilkCanvas() {
            const c = document.getElementById('silk-canvas');
            if (!c) return;
            const ctx = c.getContext('2d');
            let w, h;
            let nodes = [];

            function resize() { 
                w = c.width = window.innerWidth; 
                h = c.height = window.innerHeight; 
                createNodes();
            }

            function createNodes() {
                nodes = [];
                for(let i=0; i<50; i++) {
                    nodes.push({
                        x: Math.random() * w,
                        y: Math.random() * h,
                        vx: (Math.random() - 0.5) * 0.5,
                        vy: (Math.random() - 0.5) * 0.5,
                        r: Math.random() * 150 + 50
                    });
                }
            }

            function loop() {
                ctx.clearRect(0,0,w,h);
                
                nodes.forEach(n => {
                    n.x += n.vx; n.y += n.vy;
                    if(n.x < -100) n.x = w+100; if(n.x > w+100) n.x = -100;
                    if(n.y < -100) n.y = h+100; if(n.y > h+100) n.y = -100;
                    
                    // Draw Soft Orbs (Bokeh)
                    const g = ctx.createRadialGradient(n.x, n.y, 0, n.x, n.y, n.r);
                    g.addColorStop(0, "rgba(212, 175, 155, 0.15)"); // Rose tint
                    g.addColorStop(1, "rgba(255, 255, 255, 0)");
                    
                    ctx.fillStyle = g;
                    ctx.beginPath();
                    ctx.arc(n.x, n.y, n.r, 0, Math.PI*2);
                    ctx.fill();
                });

                requestAnimationFrame(loop);
            }

            window.addEventListener('resize', resize);
            resize();
            loop();
        }

        /**
         * ==================================================================
         * CUSTOM CURSOR
         * ==================================================================
         */
        function initCursor() {
            const cursor = document.getElementById('cursor');
            if (!cursor) return;
            document.addEventListener('mousemove', e => {
                cursor.style.top = e.clientY + 'px';
                cursor.style.left = e.clientX + 'px';
            });
            
            // Hover Effects
            document.addEventListener('mouseover', e => {
                if(e.target.classList.contains('hover-target') || e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
                    cursor.classList.add('hovered');
                } else {
                    cursor.classList.remove('hovered');
                }
            });
        }
    </script>
</body>
</html>