<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Estate | Global Luxury</title>

    <!-- FONTS: Classic Authority -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- ANIMATION ENGINE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="config.js"></script>

    <style>
        /* 
         * ----------------------------------------------------------
         * 1. THE "PLATINUM" PALETTE
         * ----------------------------------------------------------
         */
        :root {
            --navy-deep: #0a192f; /* Executive Blue */
            --navy-light: #112240;
            --platinum: #e6e6e6;
            --gold-accent: #c5a059;
            --white: #ffffff;
            --slate: #8892b0;
            
            --font-serif: 'Playfair Display', serif;
            --font-sans: 'Lato', sans-serif;
            
            --container-width: 1100px;
            --shadow-soft: 0 10px 30px -10px rgba(2, 12, 27, 0.1);
            --shadow-hard: 0 20px 50px -10px rgba(2, 12, 27, 0.3);
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background-color: #f8f9fa;
            color: var(--navy-deep);
            font-family: var(--font-sans);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* 
         * ----------------------------------------------------------
         * 2. UI COMPONENTS
         * ----------------------------------------------------------
         */
        
        .container { max-width: var(--container-width); margin: 0 auto; padding: 0 20px; position: relative; z-index: 2; }
        
        h1, h2, h3, h4 { font-family: var(--font-serif); color: var(--navy-deep); margin: 0; font-weight: 700; }
        p { line-height: 1.8; color: #555; }

        .section-header { text-align: center; margin-bottom: 4rem; }
        .section-header span { 
            display: block; 
            font-family: var(--font-sans); 
            text-transform: uppercase; 
            letter-spacing: 3px; 
            font-size: 0.8rem; 
            color: var(--gold-accent); 
            margin-bottom: 1rem;
            font-weight: 700;
        }
        .section-header h2 { font-size: 3rem; position: relative; display: inline-block; }
        .section-header h2::after {
            content: ''; display: block; width: 60px; height: 3px; background: var(--navy-deep);
            margin: 20px auto 0;
        }

        /* The "Executive" Button */
        .btn-classic {
            display: inline-block;
            background: var(--navy-deep);
            color: var(--white);
            padding: 18px 40px;
            font-family: var(--font-sans);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
            font-size: 0.85rem;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(10, 25, 47, 0.2);
        }
        
        /* Metallic Shine Effect */
        .btn-classic::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 50%; height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: 0.5s;
        }
        .btn-classic:hover::before { left: 100%; }
        .btn-classic:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(10, 25, 47, 0.3); }

        /* 
         * ----------------------------------------------------------
         * 3. HEADER & NAV
         * ----------------------------------------------------------
         */
        .top-bar {
            background: var(--navy-deep);
            color: var(--white);
            padding: 10px 0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        nav {
            background: var(--white);
            padding: 25px 0;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: 0.3s;
        }
        .nav-inner { display: flex; justify-content: space-between; align-items: center; }
        .brand-logo {
            font-family: var(--font-serif);
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--navy-deep);
            text-decoration: none;
            display: flex; align-items: center; gap: 10px;
        }
        .brand-logo i { color: var(--gold-accent); font-size: 1.4rem; }
        .nav-contact { font-weight: 700; color: var(--navy-deep); text-decoration: none; font-size: 0.9rem; }
        .nav-contact i { color: var(--gold-accent); margin-right: 8px; }

        /* 
         * ----------------------------------------------------------
         * 4. HERO
         * ----------------------------------------------------------
         */
        #hero {
            height: 85vh;
            position: relative;
            display: flex; align-items: center; justify-content: center;
            text-align: center;
            overflow: hidden;
            color: var(--white);
        }
        .hero-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            filter: brightness(0.6);
            z-index: 1;
        }
        .hero-content { position: relative; z-index: 2; max-width: 800px; opacity: 0; transform: translateY(30px); }
        .hero-badge {
            display: inline-block;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 20px;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-size: 0.8rem;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
        }

        /* 
         * ----------------------------------------------------------
         * 5. FEATURES (The "Sheet")
         * ----------------------------------------------------------
         */
        section { padding: 100px 0; }
        .bg-white { background: var(--white); }

        .features-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px;
        }
        .feature-item {
            text-align: center;
            padding: 40px 20px;
            border: 1px solid #eee;
            transition: 0.3s;
        }
        .feature-item:hover { border-color: var(--gold-accent); transform: translateY(-5px); box-shadow: var(--shadow-soft); }
        .feature-icon { font-size: 2.5rem; color: var(--navy-deep); margin-bottom: 20px; }
        .feature-title { font-size: 1.2rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

        /* 
         * ----------------------------------------------------------
         * 6. AGENT (The "Business Card")
         * ----------------------------------------------------------
         */
        .agent-card {
            background: var(--white);
            box-shadow: var(--shadow-hard);
            display: flex;
            flex-wrap: wrap;
        }
        .agent-photo {
            flex: 1; min-width: 300px; min-height: 500px;
            background-size: cover; background-position: center;
        }
        .agent-details {
            flex: 1; padding: 60px;
            min-width: 300px;
            display: flex; flex-direction: column; justify-content: center;
            background: url('https://www.transparenttextures.com/patterns/cream-paper.png'); /* Subtle texture */
        }
        
        /* SVG Signature */
        .signature-svg {
            width: 200px; height: auto; margin-top: 30px;
        }
        .signature-path {
            fill: none; stroke: var(--navy-deep); stroke-width: 2;
            stroke-dasharray: 1000; stroke-dashoffset: 1000;
        }

        /* 
         * ----------------------------------------------------------
         * 7. FORM (The "Contract")
         * ----------------------------------------------------------
         */
        .form-container {
            background: var(--white);
            padding: 60px;
            box-shadow: var(--shadow-soft);
            border-top: 5px solid var(--gold-accent);
            max-width: 700px; margin: 0 auto;
        }
        .form-group { margin-bottom: 25px; }
        .form-label {
            display: block; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;
            font-weight: 700; margin-bottom: 8px; color: var(--navy-deep);
        }
        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #eee;
            font-family: var(--font-sans);
            font-size: 1rem;
            color: var(--navy-deep);
            transition: 0.3s;
        }
        .form-input:focus { outline: none; border-color: var(--navy-deep); background: #fcfcfc; }
        
        /* Checkbox */
        .checkbox-wrapper { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 30px; font-size: 0.9rem; color: #666; }
        .checkbox-wrapper input { margin-top: 4px; accent-color: var(--navy-deep); }

        /* 
         * ----------------------------------------------------------
         * 8. FOOTER
         * ----------------------------------------------------------
         */
        footer {
            background: var(--navy-deep); color: var(--white); padding: 60px 0; text-align: center;
        }
        .footer-logo { font-family: var(--font-serif); font-size: 2rem; margin-bottom: 20px; display: block; }
        .footer-links a { color: #ccc; margin: 0 15px; text-decoration: none; font-size: 0.9rem; transition: 0.3s; }
        .footer-links a:hover { color: var(--white); }

        /* 
         * ----------------------------------------------------------
         * 9. MODAL
         * ----------------------------------------------------------
         */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 25, 47, 0.9);
            z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: 0.4s;
        }
        .modal-backdrop.visible { opacity: 1; pointer-events: all; }
        
        .modal-card {
            background: var(--white);
            width: 90%; max-width: 550px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            text-align: center;
            transform: translateY(30px); transition: 0.4s;
        }
        .modal-backdrop.visible .modal-card { transform: translateY(0); }
        
        .modal-btn {
            display: block; width: 100%;
            padding: 15px; margin-bottom: 10px;
            border: 1px solid #ddd; background: #f9f9f9;
            font-family: var(--font-sans); font-weight: 700; color: var(--navy-deep);
            cursor: pointer; transition: 0.2s;
        }
        .modal-btn:hover { background: var(--navy-deep); color: var(--white); border-color: var(--navy-deep); }

        @media (max-width: 768px) {
            .section-header h2 { font-size: 2rem; }
            .agent-card { flex-direction: column; }
            .agent-photo { min-height: 300px; }
            .form-container { padding: 30px; }
        }

    </style>
</head>
<body>

    <!-- CONFETTI CANVAS -->
    <canvas id="confetti-canvas" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:3000;"></canvas>

    <!-- TOP TICKER -->
    <div class="top-bar">
        <div class="container">
            Global Luxury Division &nbsp;&nbsp;|&nbsp;&nbsp; Offering Memorandum No. 4921 &nbsp;&nbsp;|&nbsp;&nbsp; Strictly Confidential
        </div>
    </div>

    <!-- NAVIGATION -->
    <nav id="navbar">
        <div class="container nav-inner">
            <a href="#" class="brand-logo">
                <i class="fas fa-landmark"></i>
                <span id="navBrandText">STERLING &amp; CO.</span>
            </a>
            <a href="tel:+" class="nav-contact" id="navPhone">
                <i class="fas fa-phone-alt"></i> <span id="phoneDisplay">Inquire</span>
            </a>
        </div>
    </nav>

    <!-- HERO -->
    <div id="hero">
        <div class="hero-bg" id="heroBg"></div>
        <div class="container hero-content">
            <span class="hero-badge">Exclusive Listing</span>
            <h1 style="font-size: clamp(2.5rem, 5vw, 4.5rem); margin-bottom: 20px;" id="heroTitle">THE ESTATE</h1>
            <p style="font-size: 1.2rem; color: #ddd; max-width: 600px; margin: 0 auto 40px;" id="heroSubtitle">An architectural triumph set upon the coast.</p>
            <a href="#contact" class="btn-classic">Request Private Showing</a>
        </div>
    </div>

    <!-- INTRODUCTION -->
    <section class="bg-white">
        <div class="container">
            <div class="section-header">
                <span>The Property</span>
                <h2>A Legacy Asset</h2>
            </div>
            <div class="features-grid" id="amenitiesGrid">
                <!-- JS Injected -->
            </div>
        </div>
    </section>

    <!-- THE AGENT -->
    <section style="background: #f0f2f5;">
        <div class="container">
            <div class="agent-card">
                <div class="agent-photo" id="agentPhotoBg"></div>
                <div class="agent-details">
                    <span style="text-transform:uppercase; letter-spacing:2px; color:#999; font-size:0.8rem;">Presented By</span>
                    <h2 style="font-size: 2.5rem; margin: 10px 0;" id="agentName">Agent Name</h2>
                    <h4 style="color: var(--gold-accent); margin-bottom: 20px;" id="agentTitle">Executive Director</h4>
                    <p id="agentBio" style="margin-bottom: 30px;">Bio text...</p>
                    
                    <!-- Signature SVG -->
                    <svg class="signature-svg" viewBox="0 0 250 80">
                        <path class="signature-path" d="M10,50 Q40,10 70,50 T130,50 T190,50" />
                        <!-- Simplified visual squiggle for effect -->
                        <path class="signature-path" d="M20,60 C50,60 50,30 80,40 S150,20 180,50" style="animation-delay: 0.5s" />
                    </svg>

                    <div style="margin-top: 30px;">
                        <a href="#" id="agentEmail" style="color: var(--navy-deep); text-decoration: none; font-weight: 700; margin-right: 20px;"><i class="fas fa-envelope"></i> Email</a>
                        <a href="#" id="agentSocial" style="color: var(--navy-deep); text-decoration: none; font-weight: 700;"><i class="fab fa-linkedin"></i> LinkedIn</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CONTACT FORM -->
    <section class="bg-white" id="contact">
        <div class="container">
            <div class="section-header">
                <span>Acquisition</span>
                <h2>Register Interest</h2>
            </div>

            <div class="form-container">
                <p style="text-align:center; margin-bottom: 30px; font-style: italic;">Please complete the form below to access the full digital brochure and floor plans.</p>
                
                <form id="leadForm">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" id="name" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" id="email" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Direct Line (Mobile)</label>
                        <input type="tel" id="phone" class="form-input" required inputmode="numeric">
                    </div>

                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="consent" required>
                        <label for="consent">
                            I authorize <strong id="consentBrokerage">[Brokerage]</strong> to contact me regarding this property listing via phone or email.
                        </label>
                    </div>

                    <button type="submit" class="btn-classic" style="width:100%;" id="submitBtn">
                        <span>Submit Inquiry</span>
                    </button>
                </form>
            </div>
        </div>
    </section>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <span class="footer-logo" id="footerBrand">STERLING &amp; CO.</span>
            <p id="footerAddress" style="color: rgba(255,255,255,0.6);">123 Luxury Lane</p>
            <div class="footer-links">
                <a href="#" id="privacyLink">Privacy Policy</a>
                <a href="#" id="termsLink">Terms of Service</a>
                <a href="#">Fair Housing</a>
            </div>
            <p style="margin-top: 30px; font-size: 0.7rem; opacity: 0.4;">&copy; <span id="year"></span> Global Luxury Division. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- MODAL -->
    <div class="modal-backdrop" id="modal">
        <div class="modal-card">
            <i class="fas fa-file-signature" style="font-size: 3rem; color: var(--navy-deep); margin-bottom: 20px;"></i>
            <h3 style="margin-bottom: 10px;" id="modalTitle">Buyer Profile</h3>
            <p style="margin-bottom: 30px; font-size: 0.9rem;">To better serve your needs, please indicate your current position.</p>
            <div id="modalOptions"></div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        /**
         * ==================================================================
         * STATE & CONFIG
         * ==================================================================
         */
        let storedInitialPayload = null;
        let collectedAnswers = {};

        /**
         * ==================================================================
         * INITIALIZATION
         * ==================================================================
         */
        document.addEventListener("DOMContentLoaded", () => {
            
            // 1. Check Config
            if (typeof config === 'undefined') {
                console.error("Config not loaded");
                return;
            }

            // 2. Populate Content
            populateV4Data();

            // 3. GSAP Animations
            gsap.registerPlugin(ScrollTrigger);

            // Hero Reveal
            gsap.to(".hero-content", { opacity: 1, y: 0, duration: 1.5, ease: "power3.out", delay: 0.2 });
            
            // Parallax Hero
            gsap.to("#heroBg", {
                yPercent: 30,
                ease: "none",
                scrollTrigger: { trigger: "#hero", start: "top top", end: "bottom top", scrub: true }
            });

            // Reveal Sections
            gsap.utils.toArray(".section-header, .feature-item, .agent-card").forEach(el => {
                gsap.from(el, {
                    opacity: 0, y: 40, duration: 1, ease: "power2.out",
                    scrollTrigger: { trigger: el, start: "top 85%" }
                });
            });

            // Signature Animation (Draws when agent card appears)
            gsap.to(".signature-path", {
                strokeDashoffset: 0,
                duration: 2,
                ease: "power2.inOut",
                scrollTrigger: { trigger: ".agent-card", start: "top 70%" }
            });
        });

        function populateV4Data() {
            // Meta
            document.title = `${config.meta.pageTitlePrefix} | Sterling & Co.`;
            
            // Nav
            const navBrandText = document.getElementById('navBrandText');
            if (navBrandText) navBrandText.textContent = (config.brokerage.name || 'STERLING & CO.').toUpperCase();
            
            const navPhone = document.getElementById('navPhone');
            const phoneDisplay = document.getElementById('phoneDisplay');
            if (navPhone && phoneDisplay && config.realtor.phone) {
                phoneDisplay.textContent = config.realtor.phone;
                navPhone.href = `tel:${config.realtor.phone.replace(/\D/g,'')}`;
            }

            // Hero
            const heroTitle = document.getElementById('heroTitle');
            // Use address for title if available
            if (heroTitle) heroTitle.textContent = (config.property.streetAddress || 'THE ESTATE').toUpperCase();
            
            const heroSubtitle = document.getElementById('heroSubtitle');
            if (heroSubtitle) heroSubtitle.textContent = config.property.heroSubtitle;

            const heroBg = document.getElementById('heroBg');
            if (heroBg && config.property.backgroundImageUrl) {
                heroBg.style.backgroundImage = `url(${config.property.backgroundImageUrl})`;
            }

            // Features / Amenities
            const grid = document.getElementById('amenitiesGrid');
            if (grid && config.openHouse.bundleItems) {
                grid.innerHTML = '';
                config.openHouse.bundleItems.forEach(item => {
                     grid.innerHTML += `
                        <div class="feature-item">
                            <i class="${item.icon} feature-icon"></i>
                            <div class="feature-title">${item.text}</div>
                            <p style="font-size:0.9rem; margin:0;">&nbsp;</p> <!-- Desc removed in simplified model -->
                        </div>`;
                });
            }

            // Agent
            setText('agentName', config.realtor.fullName);
            setText('agentTitle', config.realtor.title);
            setText('agentBio', config.realtor.bio);
            
            const agentPhotoBg = document.getElementById('agentPhotoBg');
            if (agentPhotoBg && config.realtor.photoUrl) {
                agentPhotoBg.style.backgroundImage = `url(${config.realtor.photoUrl})`;
            }

            // Agent Contact
            const agentEmail = document.getElementById('agentEmail');
            if (agentEmail) {
                agentEmail.href = `mailto:${config.realtor.email}`;
            }
            
            // Agent Social (Loop to find first available or default)
            const agentSocial = document.getElementById('agentSocial');
            if (agentSocial && config.realtor.social) {
                // Find first non-empty social link
                const firstSocial = Object.entries(config.realtor.social).find(([k, v]) => v && v.length > 0);
                if (firstSocial) {
                    const [platform, url] = firstSocial;
                    const iconMap = { linkedin: 'fab fa-linkedin', instagram: 'fab fa-instagram', facebook: 'fab fa-facebook-f', twitter: 'fab fa-twitter', website: 'fas fa-globe' };
                    agentSocial.innerHTML = `<i class="${iconMap[platform] || 'fas fa-link'}"></i> ${platform.charAt(0).toUpperCase() + platform.slice(1)}`;
                    agentSocial.href = url;
                    agentSocial.target = "_blank";
                } else {
                    agentSocial.style.display = 'none';
                }
            }

            // Footer / Consent
            setText('consentBrokerage', config.brokerage.name);
            setText('footerBrand', config.brokerage.name); // Updates .footer-logo text if ID matches
            // Also update class-based footer logo text just in case ID didn't catch it
            const footerLogoClass = document.querySelector('.footer-logo');
            if (footerLogoClass) footerLogoClass.textContent = (config.brokerage.name || 'STERLING & CO.').toUpperCase();

            setText('footerAddress', config.brokerage.address);
            setText('year', new Date().getFullYear());

            // Legal Links
            const privacyLink = document.getElementById('privacyLink');
            if (privacyLink && config.meta.privacyPolicyLink) {
                privacyLink.href = config.meta.privacyPolicyLink;
                privacyLink.target = "_blank";
            }
        }

        // Helpers
        function setText(id, txt) { const el = document.getElementById(id); if (el) el.textContent = txt; }


        /**
         * ==================================================================
         * FORM & LOGIC
         * ==================================================================
         */
        const form = document.getElementById('leadForm');
        
        // Phone Formatter
        document.getElementById('phone')?.addEventListener('input', function (e) {
            var x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });

        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Simulate processing
                const btn = document.getElementById('submitBtn');
                if (btn) {
                    btn.innerHTML = "<span>Processing...</span>";
                    btn.style.background = "#333";
                }

                // 1. Build Initial Payload
                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const phone = document.getElementById('phone').value;
                const submittedAt = new Date().toISOString();

                const initialPayload = {
                    formType: "initial_contact",
                    email: email,
                    fullName: name,
                    phone: phone,
                    propertyAddress: config.property.streetAddress,
                    submittedAt: submittedAt,
                    questions: [],
                    agentEmail: config.realtor.email,
                    ...(config.deploymentInfo || {})
                };

                storedInitialPayload = initialPayload;

                // 2. Send to Webhook
                const visitorUrl = config.settings.visitorWebhookUrl;
                if (visitorUrl) {
                    try {
                        fetch(visitorUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(initialPayload)
                        }); // Fire and forget
                    } catch (err) {
                        console.error(err);
                    }
                }

                setTimeout(() => {
                    showModal(0);
                }, 1000);
            });
        }

        function showModal(index) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modalTitle');
            const optionsDiv = document.getElementById('modalOptions');
            
            modal.classList.add('visible');
            optionsDiv.innerHTML = '';

            // Guard
            const questions = config.modalQuestions || [];

            if(index < questions.length) {
                const q = questions[index];
                title.innerText = q.questionText;
                
                q.options.forEach(opt => {
                    const val = opt.value || opt;
                    const txt = opt.text || opt;
                    
                    const b = document.createElement('button');
                    b.className = 'modal-btn';
                    b.innerText = txt;
                    b.onclick = () => {
                        collectedAnswers[q.id] = val;
                        showModal(index + 1);
                    };
                    optionsDiv.appendChild(b);
                });
            } else {
                finish();
            }
        }

        async function finish() {
            // 1. Process Answers
            const questions = config.modalQuestions || [];
            const modalQuestionResponses = [];

             for (const [qId, answerVal] of Object.entries(collectedAnswers)) {
                const qObj = questions.find(q => q.id === qId);
                if (qObj) {
                    const optObj = qObj.options.find(o => o.value === answerVal);
                    modalQuestionResponses.push({
                        question: qObj.questionText,
                        answer: optObj ? optObj.text : answerVal
                    });
                }
            }

            // 2. Build Final Payload
            const finalPayload = {
                ...(storedInitialPayload || {}),
                formType: "modal_answers",
                submittedAt: new Date().toISOString(),
                questions: modalQuestionResponses
            };

            // 3. Send to Webhook
            const visitorUrl = config.settings.visitorWebhookUrl;
            if (visitorUrl) {
                try {
                    await fetch(visitorUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(finalPayload)
                    });
                } catch (err) {
                    console.error("Final submit error", err);
                }
            }

            // 4. Update UI
            const modalCard = document.querySelector('.modal-card');
            modalCard.innerHTML = `
                <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--navy-deep); margin-bottom: 20px;"></i>
                <h2>Inquiry Received</h2>
                <p>The brochure has been dispatched to your email address.</p>
                <button onclick="location.reload()" class="btn-classic" style="margin-top:20px;">Close</button>
            `;
            fireConfetti();
        }

        function fireConfetti() {
            const end = Date.now() + 3000;
            // Use config colors or fallback
            const colors = config.settings.confettiColors || ['#0a192f', '#c5a059', '#e6e6e6'];
            
            (function frame() {
                confetti({
                    particleCount: 3,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: colors,
                    shapes: ['square']
                });
                confetti({
                    particleCount: 3,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: colors,
                    shapes: ['square']
                });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

    </script>
</body>
</html>